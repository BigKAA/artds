# ============================================================
# Prometheus Manual Configuration Example
# ============================================================
# This configuration deploys a standalone Prometheus instance
# that uses annotation-based discovery to scrape artds metrics.
#
# Use this when you don't have Prometheus Operator installed
# and have configured artds with:
#   scrapingMethod: annotations
#
# Deploy with:
#   kubectl apply -f prometheus-manual.yaml
#
# Access Prometheus UI:
#   kubectl port-forward -n monitoring svc/prometheus 9090:9090
#   Open http://localhost:9090
# ============================================================

---
# Namespace for Prometheus
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring

---
# ServiceAccount for Prometheus
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring

---
# ClusterRole with permissions for pod discovery
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
  # Permissions for discovering pods, services, endpoints
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/metrics
      - services
      - endpoints
      - pods
    verbs: ["get", "list", "watch"]

  # Permissions for discovering ingresses
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
    verbs: ["get", "list", "watch"]

  # Permissions for metrics endpoints
  - nonResourceURLs:
      - /metrics
      - /metrics/cadvisor
    verbs: ["get"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
  - kind: ServiceAccount
    name: prometheus
    namespace: monitoring

---
# ConfigMap with Prometheus configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 30s
      scrape_timeout: 10s
      evaluation_interval: 30s
      external_labels:
        cluster: 'kubernetes'
        prometheus: 'manual'

    # Alertmanager configuration (optional)
    # alerting:
    #   alertmanagers:
    #     - static_configs:
    #         - targets:
    #             - alertmanager:9093

    # Rule files (optional)
    # rule_files:
    #   - '/etc/prometheus/rules/*.yml'

    scrape_configs:
      # ============================================================
      # Kubernetes Pods Discovery with Annotations
      # ============================================================
      # This scrape configuration discovers pods with Prometheus annotations:
      # - prometheus.io/scrape: "true"
      # - prometheus.io/port: "9313"
      # - prometheus.io/path: "/metrics"
      # ============================================================
      - job_name: 'kubernetes-pods'

        kubernetes_sd_configs:
          - role: pod

        # Keep only pods with prometheus.io/scrape: "true"
        relabel_configs:
          # Check if prometheus.io/scrape annotation exists and equals "true"
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true

          # Get scrape path from prometheus.io/path annotation (default: /metrics)
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)

          # Get scrape port from prometheus.io/port annotation
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__

          # Add namespace label
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace

          # Add pod name label
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name

          # Add pod label as instance
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: instance

          # Add all pod labels as metrics labels
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)

          # Add pod phase (Running, Pending, etc.)
          - source_labels: [__meta_kubernetes_pod_phase]
            action: replace
            target_label: pod_phase

          # Add pod node name
          - source_labels: [__meta_kubernetes_pod_node_name]
            action: replace
            target_label: kubernetes_node

      # ============================================================
      # Kubernetes Services Discovery (optional)
      # ============================================================
      # Discovers services with prometheus.io annotations
      # Useful for monitoring service-level metrics
      # ============================================================
      - job_name: 'kubernetes-services'

        kubernetes_sd_configs:
          - role: service

        metrics_path: /metrics

        relabel_configs:
          # Keep only services with prometheus.io/scrape: "true"
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
            action: keep
            regex: true

          # Get scrape path from annotation
          - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)

          # Get scrape port from annotation
          - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__

          # Add namespace label
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace

          # Add service name label
          - source_labels: [__meta_kubernetes_service_name]
            action: replace
            target_label: kubernetes_name

          # Add all service labels
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)

      # ============================================================
      # Prometheus Self-Monitoring
      # ============================================================
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

---
# PersistentVolumeClaim for Prometheus data
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-data
  namespace: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: managed-nfs-storage  # Change to your StorageClass
  resources:
    requests:
      storage: 10Gi

---
# Deployment for Prometheus
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    app: prometheus
    component: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
        component: monitoring
    spec:
      serviceAccountName: prometheus

      containers:
        - name: prometheus
          image: prom/prometheus:v2.48.0
          imagePullPolicy: IfNotPresent

          args:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--storage.tsdb.retention.time=15d'
            - '--storage.tsdb.retention.size=9GB'
            - '--web.console.libraries=/usr/share/prometheus/console_libraries'
            - '--web.console.templates=/usr/share/prometheus/consoles'
            - '--web.enable-lifecycle'
            - '--web.enable-admin-api'

          ports:
            - name: web
              containerPort: 9090
              protocol: TCP

          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 1000m
              memory: 2Gi

          livenessProbe:
            httpGet:
              path: /-/healthy
              port: web
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /-/ready
              port: web
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3

          volumeMounts:
            - name: config
              mountPath: /etc/prometheus
              readOnly: true
            - name: data
              mountPath: /prometheus

      volumes:
        - name: config
          configMap:
            name: prometheus-config
        - name: data
          persistentVolumeClaim:
            claimName: prometheus-data

---
# Service for Prometheus UI
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    app: prometheus
    component: monitoring
spec:
  type: ClusterIP  # Change to LoadBalancer or NodePort if needed
  selector:
    app: prometheus
  ports:
    - name: web
      port: 9090
      targetPort: web
      protocol: TCP

---
# Optional: Ingress for Prometheus UI
# Uncomment and configure if you have Ingress controller
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: prometheus
#   namespace: monitoring
#   annotations:
#     kubernetes.io/ingress.class: nginx
#     # Add authentication annotations for security
#     # nginx.ingress.kubernetes.io/auth-type: basic
#     # nginx.ingress.kubernetes.io/auth-secret: prometheus-basic-auth
# spec:
#   rules:
#     - host: prometheus.example.com
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: prometheus
#                 port:
#                   number: 9090
