---
apiVersion: batch/v1
kind: Job
metadata:
  name: artds-init
  namespace: artldap
  labels:
    app: artds
    component: initialization
spec:
  # Количество попыток перезапуска при неудаче
  backoffLimit: 3

  # TTL после завершения (автоудаление через 24 часа)
  ttlSecondsAfterFinished: 86400

  template:
    metadata:
      labels:
        app: artds
        component: initialization
    spec:
      # ServiceAccount для доступа к Kubernetes API
      # (необходим для рестарта StatefulSet)
      serviceAccountName: artds-init-sa

      # Политика рестарта: никогда не перезапускать pod после завершения
      restartPolicy: Never

      # ====================================================
      # Контейнер с инициализационным скриптом
      # ====================================================
      containers:
        - name: init
          image: 389ds/dirsrv:3.1
          imagePullPolicy: IfNotPresent

          # Команда: запуск bash скрипта из ConfigMap
          command: ["/bin/bash"]
          args: ["/scripts/script-init.sh"]

          # ====================================================
          # Переменные окружения для скрипта
          # ====================================================
          env:
            # Имя StatefulSet
            - name: DS_POD_NAME
              value: "artds"

            # Имя headless service
            - name: DS_HL_SVC_NAME
              value: "artds-hl"

            # Порт LDAP
            - name: DS_SVC_PORT
              value: "3389"

            # Суффикс LDAP
            - name: DS_SUFFIX_NAME
              value: "dc=test,dc=local"

            # Количество реплик (будем использовать в helmChart)
            - name: NUMBER_OF_REPLICAS
              value: "2"

            # Пароль Directory Manager
            - name: DS_DM_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: artds-admin-secret
                  key: DS_DM_PASSWORD

            # Пароль для репликации
            - name: DS_REPL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: artds-admin-secret
                  key: DS_REPL_PASSWORD

          volumeMounts:
            # Инициализационный скрипт
            - name: init-script
              mountPath: /scripts
              readOnly: true

            # LDIF файлы для структуры дерева
            - name: infra-ldif
              mountPath: /etc/openldap/init
              readOnly: true

          resources:
            requests:
              memory: "128Mi"
              cpu: "250m"
            limits:
              memory: "256Mi"
              cpu: "500m"

      volumes:
        # Скрипт инициализации из ConfigMap
        - name: init-script
          configMap:
            name: artds-init-script
            defaultMode: 0755  # Executable

        # LDIF файлы из ConfigMap
        - name: infra-ldif
          configMap:
            name: artds-infra-ldif
