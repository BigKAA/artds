# ConfigMap с LDIF файлами для инициализации структуры LDAP дерева
# Содержит:
# - init-config-modify.ldiff - Добавление ACI (Access Control Instructions)
# - init-config.ldiff - Создание базовой структуры OU и групп
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: artds-infra-ldif
  namespace: artldap
  labels:
    app: artds
    component: ldap-structure
data:
  # =================================================================
  # Модификация корневого суффикса для добавления ACI
  # Эквивалент: ldapmodify -c -f /var/ldap/initConfigModify.ldif
  # =================================================================
  init-config-modify.ldif: |
    dn: dc=test,dc=local
    changetype: modify
    add: aci
    aci: (targetattr ="*")(version 3.0;acl "Directory Administrators Group";allow (all) (groupdn = "ldap:///cn=Directory Administrators,dc=test,dc=local");)
    -
    add: aci
    aci: (targetattr="ou || objectClass")(targetfilter="(objectClass=organizationalUnit)")(version 3.0; acl "Enable anyone ou read"; allow (read, search, compare)(userdn="ldap:///anyone");)

  # =================================================================
  # Создание базовой структуры LDAP дерева
  # Эквивалент: ldapadd -c -f /var/ldap/init-config.ldiff
  # =================================================================
  init-config.ldif: |
    # Organizational Unit: Groups
    dn: ou=Groups,dc=test,dc=local
    objectClass: organizationalunit
    objectClass: top
    ou: Groups
    aci: (targetattr="cn || member || gidNumber || description || objectClass")(targetfilter="(objectClass=groupOfUniqueNames)")(version 3.0; acl "Enable group_admin to manage groups"; allow (write, add, delete)(groupdn="ldap:///cn=group_admin,ou=permissions,dc=test,dc=local");)
    aci: (targetattr="cn || member || memberUid || gidNumber || nsUniqueId || description || objectClass")(targetfilter="(objectClass=groupOfUniqueNames)")(version 3.0; acl "Enable anyone group read"; allow (read, search, compare)(userdn="ldap:///anyone");)
    aci: (targetattr="member")(targetfilter="(objectClass=groupOfUniqueNames)")(version 3.0; acl "Enable group_modify to alter members"; allow (write)(groupdn="ldap:///cn=group_modify,ou=permissions,dc=test,dc=local");)

    # Organizational Unit: People
    dn: ou=People,dc=test,dc=local
    objectClass: organizationalunit
    objectClass: top
    ou: People
    aci: (targetattr="displayName || legalName || userPassword || nsSshPublicKey")(version 3.0; acl "Enable self partial modify"; allow (write)(userdn="ldap:///self");)
    aci: (targetattr="legalName || telephoneNumber || mobile || sn")(targetfilter="(|(objectClass=nsPerson)(objectClass=inetOrgPerson))")(version 3.0; acl "Enable self legalname read"; allow (read, search, compare)(userdn="ldap:///self");)
    aci: (targetattr="legalName || telephoneNumber")(targetfilter="(objectClass=nsPerson)")(version 3.0; acl "Enable user legalname read"; allow (read, search, compare)(groupdn="ldap:///cn=user_private_read,ou=permissions,dc=test,dc=local");)
    aci: (targetattr="objectClass || description || nsUniqueId || uid || displayName || loginShell || uidNumber || gidNumber || gecos || homeDirectory || cn || memberOf || mail || nsSshPublicKey || nsAccountLock || userCertificate")(targetfilter="(objectClass=posixaccount)")(version 3.0; acl "Enable anyone user read"; allow (read, search, compare)(userdn="ldap:///anyone");)
    aci: (targetattr="uid || description || displayName || loginShell || uidNumber || gidNumber || gecos || homeDirectory || cn || memberOf || mail || legalName || telephoneNumber || mobile")(targetfilter="(&(objectClass=nsPerson)(objectClass=nsAccount))")(version 3.0; acl "Enable user admin create"; allow (write, add, delete, read)(groupdn="ldap:///cn=user_admin,ou=permissions,dc=test,dc=local");)
    aci: (targetattr="uid || description || displayName || loginShell || uidNumber || gidNumber || gecos || homeDirectory || cn || memberOf || mail || legalName || telephoneNumber || mobile")(targetfilter="(&(objectClass=nsPerson)(objectClass=nsAccount))")(version 3.0; acl "Enable user modify to change users"; allow (write, read)(groupdn="ldap:///cn=user_modify,ou=permissions,dc=test,dc=local");)
    aci: (targetattr="userPassword || nsAccountLock || userCertificate || nsSshPublicKey")(targetfilter="(objectClass=nsAccount)")(version 3.0; acl "Enable user password reset"; allow (write, read)(groupdn="ldap:///cn=user_passwd_reset,ou=permissions,dc=test,dc=local");)

    # Directory Administrators Group
    dn: cn=Directory Administrators,dc=test,dc=local
    objectClass: groupOfUniqueNames
    objectClass: top
    cn: Directory Administrators

    # Organizational Unit: Dismissed Users
    dn: ou=Dismissed,dc=test,dc=local
    objectClass: organizationalunit
    objectClass: top
    ou: Dismissed
    description: Dismissed users
    aci: (targetattr="cn || member || gidNumber || description || objectClass")(targetfilter="(objectClass=groupOfUniqueNames)")(version 3.0; acl "Enable group_admin to manage groups"; allow (write, add, delete)(groupdn="ldap:///cn=group_admin,ou=permissions,dc=test,dc=local");)
    aci: (targetattr="cn || member || memberUid || gidNumber || nsUniqueId || description || objectClass")(targetfilter="(objectClass=groupOfUniqueNames)")(version 3.0; acl "Enable anyone group read"; allow (read, search, compare)(userdn="ldap:///anyone");)
    aci: (targetattr="member")(targetfilter="(objectClass=groupOfUniqueNames)")(version 3.0; acl "Enable group_modify to alter members"; allow (write)(groupdn="ldap:///cn=group_modify,ou=permissions,dc=test,dc=local");)

    # Organizational Unit: Permissions
    dn: ou=permissions,dc=test,dc=local
    objectClass: organizationalunit
    objectClass: top
    ou: permissions

    # Organizational Unit: Services
    dn: ou=services,dc=test,dc=local
    objectClass: organizationalunit
    objectClass: top
    ou: services
    aci: (targetattr="objectClass || description || nsUniqueId || cn || memberOf || nsAccountLock")(targetfilter="(objectClass=netscapeServer)")(version 3.0; acl "Enable anyone service account read"; allow (read, search, compare)(userdn="ldap:///anyone");)

    # Permission Groups
    dn: cn=group_admin,ou=permissions,dc=test,dc=local
    objectClass: groupOfUniqueNames
    objectClass: top
    cn: group_admin

    dn: cn=group_modify,ou=permissions,dc=test,dc=local
    objectClass: groupOfUniqueNames
    objectClass: top
    cn: group_modify

    dn: cn=user_admin,ou=permissions,dc=test,dc=local
    objectClass: groupOfUniqueNames
    objectClass: top
    cn: user_admin

    dn: cn=user_modify,ou=permissions,dc=test,dc=local
    objectClass: groupOfUniqueNames
    objectClass: top
    cn: user_modify

    dn: cn=user_passwd_reset,ou=permissions,dc=test,dc=local
    objectClass: groupOfUniqueNames
    objectClass: top
    cn: user_passwd_reset

    dn: cn=user_private_read,ou=permissions,dc=test,dc=local
    objectClass: groupOfUniqueNames
    objectClass: top
    cn: user_private_read
