
# StatefulSet для развертывания 389ds кластера
# Эквивалент Docker: docker run для двух контейнеров с persistent storage
#
# StatefulSet используется вместо Deployment для:
# - Стабильных сетевых идентификаторов (artds-0, artds-1)
# - Упорядоченного развертывания подов
# - Persistent storage для каждого пода
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: artds
  labels:
    app: artds
    component: directory-server
spec:
  # Имя headless service для DNS discovery
  serviceName: artds-hl

  # Количество реплик
  replicas: 2

  # Селектор подов
  selector:
    matchLabels:
      app: artds
      component: directory-server

  # Шаблон пода
  template:
    metadata:
      labels:
        app: artds
        component: directory-server
    spec:
      # ====================================================
      # Anti-affinity: принудительное размещение на разных worker нодах
      # ====================================================
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - artds
              # КРИТИЧНО: размещать поды на разных нодах
              topologyKey: kubernetes.io/hostname

      # ====================================================
      # Init Container проверяет номер пода.
      # Если это второй (считаем с 0) и более под,
      # возвращаем ошибку. Под не будет стартовать и
      # и будет постоянно перезагружаться.
      # ====================================================
      initContainers:
        - name: init-permissions
          image: busybox:1.37.0
          command: ['sh', '-c']
          args:
            - |
              NUM=$(echo $POD_NAME | cut -f2 -d'-')
              if [ $NUM -gt 1 ]; then
                echo "Number of replicas must be 1 or 2"
                exit 1
              fi
              # Установка прав доступа
              chmod 755 /data
              echo "Initialization completed"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: data
              mountPath: /data

      # ====================================================
      # Основной контейнер 389ds
      # ====================================================
      containers:
        - name: dirsrv
          image: 389ds/dirsrv:3.1
          imagePullPolicy: IfNotPresent

          # Порты контейнера
          ports:
            - name: ldap
              containerPort: 3389
              protocol: TCP
            - name: ldaps
              containerPort: 3636
              protocol: TCP

          # Переменные окружения
          env:
            # Суффикс LDAP
            - name: DS_SUFFIX_NAME
              value: "dc=test,dc=local"

            # Пароль Directory Manager из Secret
            - name: DS_DM_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: artds-admin-secret
                  key: DS_DM_PASSWORD

            # Переиндексация при первом запуске
            - name: DS_REINDEX
              value: "True"

            # Уровень логирования (опционально)
            # - name: DS_ERRORLOG_LEVEL
            #   value: "266354688"

          # ====================================================
          # Volume Mounts
          # ====================================================
          volumeMounts:
            # Persistent data
            - name: data
              mountPath: /data

            # TLS сертификаты от cert-manager
            - name: tls-certs
              mountPath: /data/tls
              readOnly: true
            - name: dirsrv-tls-ca
              mountPath: '/data/tls/ca'
              readOnly: true

          # ====================================================
          # Health Checks
          # ====================================================
          livenessProbe:
            exec:
              command:
                - /usr/lib/dirsrv/dscontainer
                - -H
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            exec:
              command:
                - /usr/lib/dirsrv/dscontainer
                - -H
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

          # ====================================================
          # Resource Limits
          # ====================================================
          resources:
            requests:
              cpu: "1"
              memory: "512Mi"
            limits:
              cpu: "2"
              memory: "2048Mi"

      # ====================================================
      # Volumes
      # ====================================================
      volumes:
        # TLS сертификаты от cert-manager
        - name: tls-certs
          secret:
            secretName: artds-tls-secret
        
        # Сертификат CA необходимо монтировать в другую точку файловой
        # системы контейнера
        - name: dirsrv-tls-ca
          secret:
            secretName: artds-tls-secret
            items:
            - key: ca.crt
              path: ca.crt

  # ====================================================
  # VolumeClaimTemplates - автоматическое создание PVC для каждого пода
  # Эквивалент Docker: -v /var/ldap:/data
  # ====================================================
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app: artds
          component: storage
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: managed-nfs-storage
        resources:
          requests:
            storage: 1Gi
