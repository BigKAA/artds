1. Get the DS URL by running these commands:
{{- if contains "NodePort" .Values.services.main.type }}
  export NODE_PORT=$(kubectl get --namespace {{ .Release.Namespace }} -o jsonpath="{.spec.ports[0].nodePort}" services {{ include "artds.fullname" . }})
  export NODE_IP=$(kubectl get nodes --namespace {{ .Release.Namespace }} -o jsonpath="{.items[0].status.addresses[0].address}")
  echo ldap://$NODE_IP:$NODE_PORT
{{- else if contains "LoadBalancer" .Values.services.main.type }}
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch its status by running 'kubectl get --namespace {{ .Release.Namespace }} svc -w {{ include "artds.fullname" . }}'
  export SERVICE_IP=$(kubectl get svc --namespace {{ .Release.Namespace }} {{ include "artds.fullname" . }} --template "{{"{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}"}}")
  echo ldap://$SERVICE_IP:{{ .Values.services.main.port }}
{{- else if contains "ClusterIP" .Values.services.main.type }}
  export POD_NAME=$(kubectl get pods --namespace {{ .Release.Namespace }} -l "app.kubernetes.io/name={{ include "artds.name" . }},app.kubernetes.io/instance={{ .Release.Name }}" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace {{ .Release.Namespace }} $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit ldap://127.0.0.1:3389 to use DS"
  kubectl --namespace {{ .Release.Namespace }} port-forward $POD_NAME 3389:$CONTAINER_PORT
{{- end }}

{{- if .Values.monitoring.enabled }}

==================================================
MONITORING
==================================================

Prometheus exporter has been enabled as a sidecar container.
Scraping method: {{ .Values.monitoring.scrapingMethod }}

Metrics endpoint:
{{- $fullName := include "artds.fullname" . }}
{{- range $i := until (int .Values.replicaCount) }}
  http://{{ $fullName }}-{{ $i }}.{{ $fullName }}-metrics.{{ $.Release.Namespace }}.svc.cluster.local:{{ $.Values.monitoring.service.port }}/metrics
{{- end }}

To access metrics locally:
  kubectl port-forward -n {{ .Release.Namespace }} {{ $fullName }}-0 9313:9313
  curl http://localhost:9313/metrics | grep ldap_

{{- if eq .Values.monitoring.scrapingMethod "servicemonitor" }}
{{- if .Values.monitoring.serviceMonitor.enabled }}

ServiceMonitor has been created for Prometheus Operator.
Check targets in Prometheus UI: Status â†’ Targets

To switch to annotation-based scraping:
  helm upgrade {{ .Release.Name }} ./artds \
    --set monitoring.scrapingMethod=annotations \
    --reuse-values
{{- else }}

ServiceMonitor is disabled. To enable:
  helm upgrade {{ .Release.Name }} ./artds \
    --set monitoring.serviceMonitor.enabled=true \
    --reuse-values
{{- end }}
{{- else if eq .Values.monitoring.scrapingMethod "annotations" }}

Annotation-based scraping is enabled.
Pod annotations:
{{- range $key, $value := .Values.monitoring.annotations.pod }}
  {{ $key }}: "{{ $value }}"
{{- end }}

Prometheus will auto-discover pods with these annotations.
Ensure your Prometheus configuration includes:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod

To switch to ServiceMonitor:
  helm upgrade {{ .Release.Name }} ./artds \
    --set monitoring.scrapingMethod=servicemonitor \
    --reuse-values
{{- end }}

Key metrics:
  - ldap_connections_current: Active connections
  - ldap_operations_total: Operations counter
  - ldap_entries_total: Total entries in backend
  - ldap_backend_entry_cache_hits: Entry cache performance

{{- end }}
